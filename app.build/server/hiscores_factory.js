// Copyright 2012 Felix E. Klee <felix.klee@inka.de>

// http://www.apache.org/licenses/LICENSE-2.0

var redis=require("redis"),redisClient=require("./redis_client"),fs=require("fs"),insertHiscoreScript=fs.readFileSync(__dirname+"/insert_hiscore.lua","utf8"),create,load,listen,emit,hiscoreIsValid,redisScore,nRotationsFromRedisScore,insertHiscore;hiscoreIsValid=function(e){return e.nRotations===e.rotations.length&&e.name!==""},redisScore=function(e){var t=Math.pow(2,46),n=Date.now(),r=1-n/t;return r<0?(console.error("Score overflow"),!1):e+r},nRotationsFromRedisScore=function(e){return Math.floor(e)},insertHiscore=function(e,t){var n=redisScore(e.nRotations);if(n===!1)return;redisClient.eval(insertHiscoreScript,1,t.toString(),n,e.name.toString(),JSON.stringify(e.rotations),function(e){e&&console.error(e)})},listen=function(e,t){e.on("hiscore for "+t,function(n){hiscoreIsValid(n)&&(insertHiscore(n,t),emit.call(this,e,t),emit.call(this,e.broadcast,t))})},emit=function(e,t){var n=function(n,r){var i=[],s,o,u,a;if(n){console.error(n);return}for(s=0;s<r.length;s+=2)o=r[s],u=parseFloat(r[s+1]),a=nRotationsFromRedisScore(u),i.push({name:o,nRotations:a});e.emit("hiscores for "+t,i)};redisClient.zrange(t.toString(),0,6,"WITHSCORES",n)},create=function(e){return Object.create(null,{listen:{value:function(t){listen.call(this,t,e)}},emit:{value:function(t){emit.call(this,t,e)}}})},module.exports=Object.create(null,{create:{value:create}})